<script setup>
import '@harbour-enterprises/common/styles/common-styles.css';
import '@harbour-enterprises/common/icons/icons.css';
import * as Y from 'yjs';
import { FirestoreProvider } from '@harbour-enterprises/common/collaboration/firestore-provider';

import { ref, computed, onMounted } from 'vue';
import { initializeApp } from 'firebase/app';
import BasicUpload from './BasicUpload.vue';
import BlankDOCX from '@harbour-enterprises/common/data/blank.docx?url';
import EditorInputs from './EditorInputs/EditorInputs.vue';
import { DOCX } from '@harbour-enterprises/common';
import { INPUTS } from '../config/agreement-editor.js';
import { SuperToolbar } from '@components/toolbar/super-toolbar';
import { fieldAnnotationHelpers } from '@extensions/index.js';

// Import the component the same you would in your app
import { SuperEditor } from '@/index';

let activeEditor;
const currentFile = ref(null);

const handleNewFile = async (file) => {
  currentFile.value = null;
  const fileUrl = URL.createObjectURL(file);
  currentFile.value = await getFileObject(fileUrl, file.name, file.type);
}

const getFileObject = async (fileUrl, name, type) => {
  // Generate a file url
  const response = await fetch(fileUrl);
  const blob = await response.blob();
  return new File([blob], name, { type: type });
}

const onCreate = ({ editor }) => {
  console.debug('[Dev] Editor created', editor);
  console.debug('[Dev] Page styles (pixels)', editor.getPageStyles());
  console.debug('[Dev] document styles', editor.converter?.getDocumentDefaultStyles());

  activeEditor = editor;
  window.editor = editor;

  editor.setToolbar(initToolbar());
  editor.toolbar.on('superdoc-command', ({ item, argument }) => {
    const { command } = item;
    if (command === 'setDocumentMode') {
      editor.setDocumentMode(argument);
    }
  });
  attachAnnotationEventHandlers();
}

const onCommentClicked = ({ conversation }) => {
  console.debug('ðŸ’¬ [Dev] Comment active', conversation);
};

// TODO: Replace with your firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCp2UcE6rd6fEARbFq24hySs5Thoa0LVfw",
  authDomain: "firestore-db-test-8db0d.firebaseapp.com",
  projectId: "firestore-db-test-8db0d",
  storageBucket: "firestore-db-test-8db0d.appspot.com",
  messagingSenderId: "439692670335",
  appId: "1:439692670335:web:53f3d91de63939eac3564a"
}

const getFirestoreProvider = () => {
  const ydoc = new Y.Doc();
  const firebaseApp = initializeApp(firebaseConfig);
  const providerConfig = {
    maxUpdatesPerBlob: 10,
    maxUpdatePause: 250,
  };
  const documentPath = `superdoc/tests/documents/${currentFile.value.name}`;
  return [
    ydoc,
    // new FireProvider({firebaseApp, ydoc, path: documentPath, maxWaitFirestoreTime: 100, maxUpdatesThreshold: 2})
    new FirestoreProvider(firebaseApp, ydoc, documentPath.split('/'), providerConfig)
  ];
};

const editorOptions = computed(() => {
  const [ydoc, collaborationProvider] = getFirestoreProvider();
  return {
    ydoc: ydoc || new Y.Doc(),
    // Enable these lines for collaboration testing in the dev environment
    // isNewFile: true,
    // collaborationProvider,
    onCreate,
    onCommentClicked,
    users: [
      { name: 'Nick Bernal', email: 'nick@harbourshare.com' },
      { name: 'Artem Nistuley', email: 'nick@harbourshare.com' },
      { name: 'Matthew Connelly', email: 'matthew@harbourshare.com' },
      { name: 'Eric Doversberger', email: 'eric@harbourshare.com'} 
    ],
  }
});

const exportDocx = async () => {
  const result = await activeEditor?.exportDocx();
  const blob = new Blob([result], { type: DOC_TYPE });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'exported.docx';
  a.click();
}

/* Inputs pane and field annotations */
const draggedInputId = ref(null)
const activeSigner = ref(null);
const signersListInfo = ref([
  {
    signerindex: 0,
    signername: "Signer 1",
    signeremail: "signer1@harbourshare.com",
    isactive: true,
    signercolor: "#016c59",
    iselementvisible: true,
    signeriseditable: true,
    sortorder: 0,
    signerid: "signerid-1723657655732-7x1vne6lq1r",
    iscreator: false
  },
  {
    signerindex: 1,
    signername: "Signer 2",
    signeremail: "signer2@harbourshare.com",
    isactive: true,
    signercolor: "#6943d0",
    iselementvisible: true,
    signeriseditable: true,
    sortorder: 1,
    signerid: "signerid-1723657671736-msk8e5qpd0c",
    iscreator: false
  },
]);

const updateDraggedInputId = (inputId) => {
  draggedInputId.value = inputId;
};

const updateActiveSigner = (signerIdx) => {
  activeSigner.value = signerIdx;
};

const attachAnnotationEventHandlers = () => {
  // Handle field drop outside editor.
  activeEditor?.on('fieldAnnotationDropped', ({ 
    sourceField,
    editor, 
    coordinates, 
    pos 
  }) => {
    console.log('fieldAnnotationDropped', { sourceField });

    let signer = signersListInfo.value.find((signer) => signer.signerindex === activeSigner.value);

    editor.commands.addFieldAnnotation(pos, {
      displayLabel: 'Enter your info',
      fieldId: `agreementinput-${Date.now()}-${Math.floor(Math.random() * 1000000000000)}`,
      fieldType: 'TEXTINPUT',
      fieldColor: signer?.signercolor,
    });

    // editor.commands.addFieldAnnotation(pos, {
    //   displayLabel: 'Upload your image',
    //   fieldId: `agreementinput-${Date.now()}-${Math.floor(Math.random() * 1000000000000)}`,
    //   fieldType: 'IMAGEINPUT',
    //   fieldColor: signer?.signercolor,
    //   imageSrc: 'https://placehold.co/200x200?text=Image',
    //   type: 'image',
    // });

    // editor.commands.addFieldAnnotation(pos, {
    //   displayLabel: 'Signature',
    //   fieldId: `agreementinput-${Date.now()}-${Math.floor(Math.random() * 1000000000000)}`,
    //   fieldType: 'SIGNATUREINPUT',
    //   fieldColor: signer?.signercolor,
    //   imageSrc: 'https://placehold.co/85x25?text=Signature',
    //   type: 'signature',
    // });
  });

  activeEditor?.on('fieldAnnotationClicked', (params) => {
    console.log('fieldAnnotationClicked', { params });
  });

  // Update annotations by fieldId.
  // setTimeout(() => {
  //   activeEditor?.commands.updateFieldAnnotations('agreementinput-1723720330834-228771403177', {
  //     displayLabel: 'Updated!',
  //     fieldColor: '#6943d0',
  //   });
  // }, 3000);

  // Delete annotation by fieldId.
  // setTimeout(() => {
  //   activeEditor?.commands.deleteFieldAnnotations('agreementinput-1723720330834-228771403177');
  // }, 3000);

  // Get all field annotations with dom rect (to get coordinates).
  // setTimeout(() => {
  //   let fieldAnnotationsWithRect = fieldAnnotationHelpers.getAllFieldAnnotationsWithRect(
  //     'fieldAnnotation', 
  //     activeEditor.view,
  //     activeEditor.state
  //   );

  //   console.log({ fieldAnnotationsWithRect });
  // }, 3000);
};
/* Inputs pane and field annotations */

const initToolbar = () => {
  return new SuperToolbar({ element: 'toolbar', editor: activeEditor });
}

onMounted(async () => {
  // set document to blank
  currentFile.value = await getFileObject(BlankDOCX, 'blank_document.docx', DOCX);
});
</script>

<template>
  <div class="dev-app">
    <div class="dev-app__layout">

      <div class="dev-app__header">
        <div class="dev-app__header-side dev-app__header-side--left">
          <div class="dev-app__header-title">
            <h2>Super Editor Dev Area</h2>
          </div>
          <div class="dev-app__header-upload">
            Upload docx
            <BasicUpload @file-change="handleNewFile" accept=".docx" />
          </div>
        </div>
        <div class="dev-app__header-side dev-app__header-side--right">
          <button class="dev-app__header-export-btn" @click="exportDocx">Export</button>
        </div>
      </div>

      <div id="toolbar" class="sd-toolbar"></div>

      <div class="dev-app__main">
        <div class="dev-app__inputs-panel">
          <div class="dev-app__inputs-panel-content">
            <EditorInputs
              v-bind="{ activeSigner, signersListInfo }" 
              @dragged-input-id-change="updateDraggedInputId"
              @active-signer-change="updateActiveSigner"
            />
          </div>
        </div>

        <div class="dev-app__view">
            <div class="dev-app__content" v-if="currentFile">
              <div class="dev-app__content-container">
                <SuperEditor
                  documentId="ID-122"
                  :file-source="currentFile" 
                  :options="editorOptions"
                />
              </div>
            </div>
        </div>
      </div>

    </div>
  </div>
</template>

<style>
*,
::before,
::after {
  box-sizing: border-box;
}

.ProseMirror p {
  margin: 0;
  padding: 0;
}
.comment-highlight {
  /* background-color: red; */
}
</style>

<style scoped>
.dev-app {
  --header-height: 154px;
  --toolbar-height: 39px;

  width: 100%;
  height: 100vh;
}

.dev-app__layout {
  display: grid;
  width: 100%;
  height: 100vh;
}

.dev-app__header {
  display: flex;
  justify-content: space-between;
  background-color: rgb(222, 237, 243);
  padding: 20px;
}

.dev-app__header-side {
  display: flex;
}
.dev-app__header-side--left {
  flex-direction: column;
}
.dev-app__header-side--right {
  align-items: flex-end;
}

.dev-app__main {
  display: grid;
  grid-template-columns: 300px minmax(0, 1fr) 300px;
  overflow-y: auto;
}

.dev-app__view {
  display: flex;
  padding-top: 20px;
  padding-left: 20px;
  padding-right: 20px;
  overflow-y: auto;
}

.dev-app__content {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}

.dev-app__content-container {
  width: 100%;
  max-width: 8.5in;
}

.dev-app__inputs-panel {
  display: grid;
  height: calc(100vh - var(--header-height) - var(--toolbar-height));
  background: #fff;
  border-right: 1px solid #dbdbdb;
}

.dev-app__inputs-panel-content {
  display: grid;
  overflow-y: auto;
  scrollbar-width: none;
}
.super-editor {
  border: 1px solid #dbdbdb;
}
</style>
